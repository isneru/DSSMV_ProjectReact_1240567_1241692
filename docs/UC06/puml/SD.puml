@startuml SD
autonumber

actor "User" as User
participant "Settings Screen" as UI
participant "AuthProvider" as Context
participant "TodoistClient" as Client
participant "Todoist API" as API
participant "SecureStore" as Store

activate User
User -> UI : press "Login with Todoist" button
activate UI
UI -> Context : login()
activate Context

Context -> Context : prompts authentication session
Context --> User : redirects user\nto oauth webpage
deactivate Context

User -> API : enters credentials\nand authorizes app
activate API
API --> Context : redirects back with authorization code
deactivate API
activate Context

Context -> Client : post(token_endpoint, code)
activate Client
Client -> API : requests access token
activate API
API --> Client : returns access token
deactivate API
Client --> Context : returns token data
deactivate Client

Context -> Client : get(user_endpoint)
activate Client
Client -> API : requests user profile
activate API
API --> Client : returns user profile
deactivate API
Client --> Context : returns user data
deactivate Client

Context -> Store : save session data
activate Store
Store --> Context : void
deactivate Store

Context -> Context : dispatch("SIGN_IN")
Context --> UI : updates authentication state
deactivate Context

UI --> User : displays user profile (logged in)
deactivate UI

@enduml